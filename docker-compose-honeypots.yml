version: '3.8'

services:
  # SSH Honeypot (Cowrie) - Already running in WSL, documented here for reference
  # cowrie:
  #   container_name: cowrie-ssh
  #   image: cowrie/cowrie:latest
  #   ports:
  #     - "2222:2222"
  #   volumes:
  #     - cowrie-logs:/cowrie/var/log/cowrie
  #     - cowrie-downloads:/cowrie/var/lib/cowrie/downloads
  #   networks:
  #     - honeynet-isolated
  #   restart: unless-stopped
  #   cap_drop:
  #     - ALL
  #   security_opt:
  #     - no-new-privileges:true
  #   read_only: true
  #   tmpfs:
  #     - /tmp:noexec,nosuid,size=100m

  # HTTP Honeypot - Glastopf (Real web app honeypot)
  glastopf:
    container_name: http-honeypot
    image: dinotools/glastopf:latest
    ports:
      - "8080:8080"
    volumes:
      - glastopf-data:/opt/glastopf
      - glastopf-logs:/var/log/glastopf
      - ./honeypots/glastopf-config:/etc/glastopf
    networks:
      - honeynet-isolated
    environment:
      - GLASTOPF_PORT=8080
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    labels:
      - "honeynet.service=http"
      - "honeynet.type=high-interaction"

  # FTP Honeypot - Using production pyftpdlib in isolated container
  ftp-honeypot:
    container_name: ftp-honeypot
    build:
      context: ./honeypots/ftp
      dockerfile: Dockerfile.secure
    ports:
      - "2121:2121"
    volumes:
      - ftp-logs:/var/log/ftp-honeypot:rw
      - ftp-files:/tmp/ftp_honeypot_files:rw
    networks:
      - honeynet-isolated
    environment:
      - FTP_PORT=2121
      - LOG_PATH=/var/log/ftp-honeypot/ftp_honeypot.json
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined  # Required for FTP passive mode
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    labels:
      - "honeynet.service=ftp"
      - "honeynet.type=medium-interaction"

  # Log Aggregator - Forwards logs to backend securely
  log-forwarder:
    container_name: log-forwarder
    build:
      context: ./honeypots/log-forwarder
      dockerfile: Dockerfile
    volumes:
      - glastopf-logs:/logs/http:ro
      - ftp-logs:/logs/ftp:ro
      - ./logs:/output:rw
    networks:
      - honeynet-isolated
      - backend-network
    environment:
      - BACKEND_URL=http://host.docker.internal:3000
      - LOG_INTERVAL=5
    restart: unless-stopped
    depends_on:
      - glastopf
      - ftp-honeypot
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=50m

networks:
  # Isolated network for honeypots (no internet access)
  honeynet-isolated:
    driver: bridge
    internal: true  # No external access
    ipam:
      config:
        - subnet: 172.25.0.0/24
    labels:
      - "honeynet.isolation=true"
  
  # Separate network for backend communication
  backend-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.26.0.0/24

volumes:
  cowrie-logs:
    driver: local
  cowrie-downloads:
    driver: local
  glastopf-data:
    driver: local
  glastopf-logs:
    driver: local
  ftp-logs:
    driver: local
  ftp-files:
    driver: local
